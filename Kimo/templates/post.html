<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>发布文章</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Vditor -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vditor/dist/index.css">
<style>
    /* ===== Loading：只做 opacity（不卡） ===== */
    @keyframes loadingFadeOut {
      to { opacity: 0; }
    }
    #global-loading.fade-out {
      animation: loadingFadeOut 0.6s ease forwards;
      pointer-events: none;
    }

    
    /* 整个编辑器像一个卡片 */ .vditor { border-radius: 0.75rem; border: 1px solid #e5e7eb; overflow: hidden; background: #fff; } /* 工具栏整体：不要紧凑 */ .vditor-toolbar { background-color: #f9fafb; border-bottom: 1px solid #e5e7eb; padding: 5px; /* ⬅️ 比之前更松 */ gap: 28px; /* ⬅️ 按钮之间拉开 */ } /* 工具栏按钮 */ .vditor-toolbar button { border-radius: 0.75rem; /* 更圆一点 */ padding: 10px 12px; /* ⬅️ 不紧凑的关键 */ display: flex; align-items: center; justify-content: center; } /* 图标放大（关键） */ .vditor-toolbar button svg { width: 30px; /* 原来大概 16 */ height: 30px; } /* 工具栏按钮 tooltip 显示在下方 */ /* 自定义 tooltip（下方） */ .vditor-toolbar button[data-tooltip] { position: relative; } .vditor-toolbar button[data-tooltip]::after { content: attr(data-tooltip); position: absolute; top: 100%; left: 50%; transform: translateX(-50%) translateY(8px); background: #111827; /* gray-900 */ color: #fff; font-size: 12px; padding: 4px 8px; border-radius: 6px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.15s ease; z-index: 50; } .vditor-toolbar button[data-tooltip]:hover::after { opacity: 1; } /* hover 效果 */ .vditor-toolbar button:hover { background-color: #e5e7eb; } /* 当前激活状态 */ .vditor-toolbar button.vditor-toolbar__item--current { background-color: #dbeafe; } /* 分割线 */ .vditor-toolbar__divider { background-color: #e5e7eb; width: 1px; margin: 0 8px; }
  </style>
</head>

<body class="bg-gray-100">
<!-- ===== Loading ===== -->
<div id="global-loading"
     class="fixed inset-0 z-[9999] flex items-center justify-center bg-white">
  <div class="w-8 h-8 border-4 border-gray-300 border-t-gray-700 rounded-full animate-spin"></div>
</div>
<header
  class="sticky top-0 z-30
         bg-white/80 backdrop-blur
         border-b border-gray-100"
>
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <div class="flex h-16 items-center justify-between">

      <!-- 左侧：标题输入 -->
      <div class="flex-1 flex items-center">
        <input
          id="titleInput"
          placeholder="文章标题"
          class="w-full max-w-2xl
                 bg-transparent
                 text-2xl tracking-tight
                 text-gray-900 placeholder-gray-400
                 focus:outline-none
                 focus:placeholder-gray-300
                 transition"
        />
      </div>

      <!-- 右侧：操作 -->
      <div class="flex items-center gap-3">

        <!-- 草稿 -->
        <button
          class="px-4 py-2 rounded-xl
                 text-sm font-medium
                 text-gray-700
                 bg-gray-100
                 hover:bg-gray-200
                 active:scale-[0.98]
                 transition"
        >
          保存草稿
        </button>

        <!-- 发布 -->
        <button
          id="sendBtn"
          class="px-5 py-2 rounded-xl
                 text-sm font-semibold
                 bg-black text-white
                 hover:bg-gray-900
                 active:scale-[0.98]
                 transition"
        >
          发布
        </button>

      </div>

    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto p-6 space-y-3">
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 ">
        <div class="col-span-1 md:col-span-2 space-y-6 basis-3/4">

            <!-- 编辑器 -->
  <section>
    <div id="vditor" class=" min-h-[800px]">

    </div>
  </section>
        </div>

    <div class="col-span-1">
        <!-- 操作 -->
  <div class="flex justify-start gap-3 ">
    
   
      {% if edit %}
      <button class="px-7 py-2 rounded-xl bg-black text-white">编辑</button>
      {% endif %}
  </div>
        <aside class="space-y-6 mb-2">
  <div class="bg-white rounded-2xl mb-4 shadow-sm border border-gray-100 p-4">
    <input rows="2"
    class="flex flex-wrap w-full rounded-xl border border-gray-200 mb-3 p-4 space-y-6"
    placeholder="文章简介（无填写则选取开头）" 
    id="descrInput">
    <!-- 封面上传区 -->
    <section
      class="group relative rounded-2xl border-2 border-dashed border-gray-200
             p-6 text-center space-y-4
             transition
             hover:border-black/40 hover:bg-gray-50"
    >
      <p class="text-sm text-gray-500 tracking-wide">
        设置封面图片
      </p>

      <!-- 选择图片 -->
      <label
        class="inline-flex items-center justify-center
               gap-2 cursor-pointer
               bg-black text-white
               px-5 py-2.5 rounded-xl
               text-sm font-medium
               transition
               hover:bg-gray-800
               active:scale-95"
      >
        选择图片
        <input
          id="coverInput"
          type="file"
          hidden
          accept="image/*"
        />
      </label>

      <!-- 预览图 -->
      <img
        id="coverPreview"
        class="hidden mx-auto max-h-48 rounded-xl shadow-md transition"
      />

      <!-- 删除按钮（弱化） -->
      <button
        id="deleteCoverButton"
        class="text-sm text-gray-500
               px-4 py-2 rounded-xl
               hover:bg-gray-100 hover:text-gray-700
               transition hidden"
      >
        删除图片
      </button>

    </section>
    
  </div>
</aside>
<aside class="space-y-6 mb-4">
  <div
    class="bg-white/80 backdrop-blur rounded-2xl shadow-sm
           border border-gray-100 p-5 transition hover:shadow-md"
  >

    <!-- 分类 -->
    <section class="grid grid-cols-1 gap-4">

      <!-- 标题 + 开关 -->
      <div class="flex items-center justify-between px-1">
        <h3 class="text-lg font-semibold text-gray-800 tracking-tight">
          分类
        </h3>

        <!-- Toggle -->
        <label
          for="CategoryConditions"
          class="relative inline-flex items-center cursor-pointer
                 [-webkit-tap-highlight-color:transparent]"
        >
          <input
            type="checkbox"
            id="CategoryConditions"
            class="peer sr-only"
          />

          <!-- Track -->
          <span
            class="w-11 h-6 bg-gray-300 rounded-full
                   transition peer-checked:bg-gray-900/80"
          ></span>

          <!-- Thumb -->
          <span
            class="absolute left-0.5 top-0.5 w-5 h-5 bg-white rounded-full
                   shadow transition-all
                   peer-checked:translate-x-5"
          ></span>
        </label>
      </div>

      <!-- 内容区 -->
      <div
        id="CategoryList"
        class="relative hidden animate-fade-in"
      >
        <div
          class="relative mt-2 rounded-xl border border-gray-200
                 bg-gray-50 focus-within:bg-white
                 focus-within:border-gray-900
                 transition"
        >
          <input
            type="text"
            id="Headline"
            list="HeadlineList"
            placeholder="选择或输入分类"
            class="w-full bg-transparent px-4 py-2.5
                   text-sm text-gray-800 placeholder-gray-400
                   outline-none rounded-xl
                   [&::-webkit-calendar-picker-indicator]:opacity-0"
          />

          <!-- 下拉图标 -->
          <span
            class="pointer-events-none absolute inset-y-0 right-3
                   flex items-center text-gray-500"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
              class="w-4 h-4"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="m19.5 8.25-7.5 7.5-7.5-7.5"
              />
            </svg>
          </span>
        </div>
      </div>

      <!-- datalist -->
      <datalist id="HeadlineList">
        {% for category in categories %}
          <option value="{{ category.name }}"></option>
        {% endfor %}
      </datalist>

    </section>
  </div>
</aside>

    </div>
    </div>
</main>
<!-- Modal -->
<div class="fixed inset-0 bg-black/40 flex items-center justify-center hidden"
     id="modal">
    <div class="bg-white rounded-xl w-80 p-6 text-center">
        <h3 class="font-semibold mb-3">提示</h3>
        <p class="text-gray-600 mb-4" id="modal-text"></p>
        <button class="px-4 py-2 bg-gray-200 rounded-lg"
                onclick="closeModal()">
            我知道了
        </button>
  </div>
</div>
<script>
function showModal(message) {
  document.getElementById('modal-text').innerText = message
  document.getElementById('modal').classList.remove('hidden')
}

function closeModal() {
  document.getElementById('modal').classList.add('hidden')
}
</script>
<script>
  const toggle = document.getElementById('CategoryConditions')

  toggle.addEventListener('change', (e) => {
    if (e.target.checked) {
      document.getElementById('CategoryList').classList.remove('hidden')
    } else {
      document.getElementById('CategoryList').classList.add('hidden')
    }
  })
</script>

<!-- Vditor JS -->
<script src="https://cdn.jsdelivr.net/npm/vditor/dist/index.min.js"></script>

<script>
  const vditor = new Vditor('vditor', {
      height: 420,
      placeholder: '在这里输入 Markdown 内容...',
       upload: {
      url: '/upload/image/vditor',   // ⭐ 上传接口
      fieldName: 'file',          // ⭐ 后端接收的字段名
      max: 5 * 1024 * 1024,        // 5MB
      accept: 'image/*',
       },
       toolbar: [
      'bold',
      'italic',
      'strike',
      'headings',
      'quote',
      'code',
      'inline-code',
      'list',
      'ordered-list',
      'link',
      'upload',
      'preview',
      'fullscreen'
    ],
      toolbarConfig: { pin: true },
       cache: {
    enable: false,
     },
    after() {
    if ('{{ postId }}'){
    let article = `{{ article }}`;
    console.log(article);
    vditor.setValue(article);
  }
  },
    });

    
    document.getElementById('sendBtn').addEventListener('click', async () => {
      const title = document.getElementById('titleInput').value.trim();
      const content = vditor.getValue().trim();
      const description = document.getElementById('descrInput').value.trim();
      const description_result = description.trim() === '' ? null : description.trim();
      const categoryToggle = document.getElementById('CategoryConditions').checked
      if (!title) {
        showModal('标题不能为空');
        return;
      }
      if (!content) {
        showModal('内容不能为空');
        return;
      }
      if (!categoryToggle) {
        category_name = null;
      }
      else{
        category_name = document.getElementById('Headline').value;
      }
 const res = await fetch('/post', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ title, content ,category_name,description_result,coverUrl})
});

const data = await res.json();

if (res.ok) {
  showModal('发布成功');
  vditor.setValue('');

  setTimeout(() => {
    window.location.href = '/';
  }, 800);
} else {
  showModal(data.message || '发布失败');
}
    });
</script>
<script>
let coveUrl;
const input = document.getElementById("coverInput");
const preview = document.getElementById("coverPreview");

let coverUrl = null; // 最终用于提交文章

input.addEventListener("change", async () => {
  const file = input.files[0];
  if (!file) return;

  // 1️⃣ 本地预览（用户体验）
  preview.src = URL.createObjectURL(file);
  preview.classList.remove("hidden");

  // 2️⃣ 组装 FormData
  const formData = new FormData();
  formData.append("file", file);

  // 3️⃣ 上传
  const res = await fetch("/upload/image", {
    method: "POST",
    body: formData
  });

  const image_data = await res.json();
  if (image_data.status) {
    coverUrl = image_data.url;
    console.log("上传成功：", coverUrl);

  } else {
    alert(image_data.msg || "上传失败");
  }
});
</script>
<!-- ===== JS ===== -->
<script>
  /* Loading */
  window.addEventListener("load", () => {
    const loader = document.getElementById("global-loading");
    loader.classList.add("fade-out");
    setTimeout(() => loader.remove(), 600);
  });

  /* Blur-up 背景 */
  document.addEventListener("DOMContentLoaded", () => {
    const el = document.getElementById("bg-image");
    const bg = getComputedStyle(el).backgroundImage.slice(5, -2);
    const img = new Image();
    img.src = bg;
    img.onload = () => el.classList.add("loaded");
  });
</script>

</body>
</html>
